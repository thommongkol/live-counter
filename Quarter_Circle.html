<!DOCTYPE html>
<html>
<head>
  <!-- 1. แก้ไข: เพิ่ม Meta Tag เพื่อให้รองรับภาษาไทย -->
  <meta charset="UTF-8">

  <style>
    body { 
      margin: 0; 
      /* 2. ปรับปรุง: ใช้ฟอนต์ที่เหมาะกับภาษาไทย */
      font-family: 'IBM Plex Sans Thai', system-ui, sans-serif; 
      background-color: transparent;
    }
    
    .counter-quarter-circle {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 150px;
      height: 150px;
      background-color: #34a853;
      color: white;
      border-top-right-radius: 150px; 
      transform: translate(-100%, 100%);
      transition: transform 0.6s ease-out;
    }
    
    .counter-quarter-circle.visible {
        transform: translate(0, 0);
    }
    
    .counter-quarter-circle .text {
        position: absolute;
        bottom: 20px;
        left: 20px;
        font-size: 18px;
        font-weight: 600;
        line-height: 1.4; /* จัดระยะห่างระหว่างบรรทัด */
    }
  </style>
  <!-- เพิ่มฟอนต์ภาษาไทยสวยๆ จาก Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@600&display=swap" rel="stylesheet">
</head>
<body>

  <div id="counter-display" class="counter-quarter-circle">
    <!-- 3. ปรับปรุง: เปลี่ยนข้อความเริ่มต้นเป็นภาษาไทย -->
    <div class="text">
        <span>กำลังเชื่อมต่อ...</span>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBQglstUR-qnDMq7CFdaC8JXYlYLe7TJqk",
      authDomain: "my-realtime-counter.firebaseapp.com",
      databaseURL: "https://my-realtime-counter-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "my-realtime-counter",
      storageBucket: "my-realtime-counter.firebasestorage.app",
      messagingSenderId: "1064997905833",
      appId: "1:1064997905833:web:ee5063e685310ac56150b8",
      measurementId: "G-2DPZF4KGY6"
    };

    // 4. อัปเกรด: เพิ่มฟังก์ชันแปลงเลขไทย
    function toThaiNumerals(n) {
      const thaiDigits = ['๐', '๑', '๒', '๓', '๔', '๕', '๖', '๗', '๘', '๙'];
      return String(n).split('').map(digit => thaiDigits[parseInt(digit)]).join('');
    }

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const presenceRef = db.ref("presence/google-sites-viewers");
    
    // 5. อัปเกรด: ใช้โค้ดนับคนแบบ 1 ต่อ 1 อุปกรณ์
    function getUniqueUserId() {
      let userId = localStorage.getItem('uniqueUserId');
      if (!userId) {
        userId = 'user-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('uniqueUserId', userId);
      }
      return userId;
    }
    const myUserId = getUniqueUserId();
    const myUserRef = presenceRef.child(myUserId);
    const tabCountKey = 'activeTabCount';
    window.addEventListener('load', () => {
      let count = parseInt(localStorage.getItem(tabCountKey) || '0', 10);
      count++;
      if (count === 1) {
        myUserRef.onDisconnect().remove();
        myUserRef.set(true);
      }
      localStorage.setItem(tabCountKey, count);
    });
    window.addEventListener('beforeunload', () => {
      let count = parseInt(localStorage.getItem(tabCountKey) || '1', 10);
      count--;
      if (count === 0) {
        myUserRef.remove();
        localStorage.removeItem(tabCountKey);
      } else {
        localStorage.setItem(tabCountKey, count);
      }
    });

    // 6. อัปเกรด: ส่วนแสดงผลเป็นภาษาไทย
    presenceRef.on("value", (snapshot) => {
      const userCount = snapshot.numChildren();
      const counterElement = document.getElementById("counter-display");
      const textElement = counterElement.querySelector('.text');
      
      counterElement.classList.add('visible'); 
      
      const thaiUserCount = toThaiNumerals(userCount);
      textElement.innerHTML = `ออนไลน์<br><strong>${thaiUserCount} คน</strong>`;
    });
  </script>

</body>
</html>
